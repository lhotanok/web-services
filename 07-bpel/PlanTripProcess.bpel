<?xml version="1.0" encoding="utf-8" ?>
<process name="TripPlanner"
    targetNamespace="http://nswi145/PlanTrip/bpel"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:tns="http://nswi145/PlanTrip/bpel"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:tnswsdl="http://nswi145/PlanTrip/wsdl"
    xmlns:tnsxsd="http://nswi145/PlanTrip/xsd"
    xmlns:trip="http://trip_planner.example.org/"
    queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
    expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">

  <import location="PlanTripProcess.wsdl"
      namespace="http://nswi145/PlanTrip/wsdl"
      importType="http://schemas.xmlsoap.org/wsdl/" />

  <partnerLinks>
    <partnerLink name="TripPlannerPartnerLink"
        partnerLinkType="tnswsdl:TripLinkType"
        myRole="TripPlannerExecutorRole" />
    <partnerLink name="GetOrCreateLink"
        partnerLinkType="tnswsdl:GetOrCreateLinkType"
        myRole="GetOrCreateClientRole"
        partnerRole="GetOrCreateRole"/>
    <partnerLink name="SetDateLink"
        partnerLinkType="tnswsdl:SetDateLinkType"
        myRole="SetDateClientRole"
        partnerRole="SetDateRole"/>
  </partnerLinks>

  <variables>
    <variable name="inputMessage" messageType="tnswsdl:TripInputMessage" />
    <variable name="outputMessage" messageType="tnswsdl:TripOutputMessage" />

    <variable name="inputTrip" element="tnswsdl:tripInput" />
    <variable name="outputTrip" element="tnswsdl:tripOutput" />

    <variable name="getOrCreateRequestElement" element="trip:getOrCreate" />
    <variable name="getOrCreateRequest" messageType="trip:getOrCreateRequest" />
    <variable name="getOrCreateResponse" messageType="trip:getOrCreateResponse" />
    <variable name="getOrCreateResponseElement" element="trip:getOrCreate" />

    <variable name="setDateRequestElement" element="trip:setDate" />
    <variable name="setDateRequest" messageType="trip:setDateRequest" />
    <variable name="setDateResponse" messageType="trip:setDateResponse" />
    <variable name="setDateResponseElement" element="trip:setDate" />
  </variables>

  <sequence>

    <receive
        name="ReceiveTripInputs"
        partnerLink="TripPlannerPartnerLink"
        portType="tnswsdl:TripPortType"
        operation="planTripWithEvents"
        variable="inputMessage"
        createInstance="yes" />

    <assign name="ParseInput">
    	<copy>
    		<from variable="inputMessage" part="parameters"/>
    		<to variable="inputTrip"/>
    	</copy>
    </assign>

    <assign name="InitGetOrCreateRequest">
      <copy>
        <from>
        	<literal>
        		<trip:getOrCreate>
              <trip:tripName></trip:tripName>
            </trip:getOrCreate>
        	</literal>
        </from>
        <to variable="getOrCreateRequestElement" />
      </copy>
      <copy>
      	<from>$inputTrip/tripName</from>
      	<to>$getOrCreateRequestElement/trip:tripName</to>
      </copy>
      <copy>
      	<from variable="getOrCreateRequestElement"/>
      	<to variable="getOrCreateRequest" part="parameters"/>
      </copy>
    </assign>

	  <invoke
        name="InvokeGetOrCreateTrip"
        partnerLink="GetOrCreateLink"
        operation="getOrCreate"
        inputVariable="getOrCreateRequest"
        outputVariable="getOrCreateResponse" />

    <assign name="ParseGetOrCreateResponse">
      <copy>
        <from variable="getOrCreateResponse" part="parameters"/>
        <to variable="getOrCreateResponseElement"/>
      </copy>
      <copy>
    		<from>$getOrCreateResponseElement</from>
    		<to variable="outputMessage" part="parameters"/>
    	</copy>
    </assign>

    <assign name="ParseSetDateInput">
    	<copy>
    		<from variable="outputMessage" part="parameters"/>
    		<to variable="outputTrip"/>
    	</copy>
    </assign>

    <assign name="InitSetDateRequest">
      <copy>
        <from>
          <literal>
            <trip:setDate>
              <trip:tripId></trip:tripId>
              <trip:dateFrom></trip:dateFrom>
              <trip:dateTo></trip:dateTo>
            </trip:setDate>
          </literal>
        </from>
        <to variable="setDateRequestElement" />
      </copy>


      <!--
        I can't figure out how 'uuid' value from 'getOrCreateResponse' should be passed
        to `setDate` operation's input.
        I tried tons of different approaches but I always ended up with 'ns2e24D:selectionFailure'
        while testing in SOAP UI. Both '$inputTrip/dateFrom' and '$inputTrip/dateTo' work fine,
        as well as 'planTripWithEvents' + 'getOrCreate' operations without `setDate' operation 🤷‍♀️
      -->
      <copy>
        <from>$outputTrip/uuid</from>
        <to>$setDateRequestElement/trip:tripId</to>
      </copy>


      <copy>
        <from>$inputTrip/dateFrom</from>
        <to>$setDateRequestElement/trip:dateFrom</to>
      </copy>
      <copy>
        <from>$inputTrip/dateTo</from>
        <to>$setDateRequestElement/trip:dateTo</to>
      </copy>
      <copy>
        <from variable="setDateRequestElement"/>
        <to variable="setDateRequest" part="parameters"/>
      </copy>
    </assign>

    <invoke
        name="InvokeSetDateForTrip"
        partnerLink="SetDateLink"
        operation="setDate"
        inputVariable="setDateRequest"
        outputVariable="setDateResponse" />

    <assign name="ParseSetDateResponse">
      <copy>
        <from variable="setDateResponse" part="parameters"/>
        <to variable="setDateResponseElement"/>
      </copy>
      <copy>
        <from>$setDateResponseElement</from>
        <to variable="outputMessage" part="parameters"/>
      </copy>
    </assign>

    <reply name="ReplyTripOutputs"
        partnerLink="TripPlannerPartnerLink"
        portType="tnswsdl:TripPortType"
        operation="planTripWithEvents"
        variable="outputMessage" />

  </sequence>

</process>